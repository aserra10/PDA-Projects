---
title: "Transportability Analysis of a Cardiovascular Risk Prediction Model"
author: "Alitzel Serrano Laguna"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

```

# Abstract
This study assesses the performance of a predictive model when transported from a source population to a new target population. This transportability analysis was conducted through a Monte Carlo simulation with 1,000 repetitions where Framingham study data was used as the source and NHANES data as the target population. Model performance was assessed with brier score estimates using an inverse odds-weighted estimand for being in the source population. The mean brier estimate for men (0.2775) is higher than for women (0.0649), with also higher bias in the estimate for men (0.2306) compared to women (0.0318). The overall mean estimate across simulations is 0.1271. Examining the brier score histogram plots reveals a right-skewed distribution, with a larger deviation from the true value in the right-tail values. Notably, the model consistently performs better in women, more closely approximating non-simulated estimates. This discrepancy suggests diminished effectiveness when applied to the underlying target population, particularly for men. The simulated NHANES data, generated by random sampling from a normal distribution, diverges from the source population data used for model development. Despite this dissimilarity, the model performs relatively well in the combined simulated data of men and women, with better model performance for predicted women outcomes.


# Introduction
This project explores the transportation of a prediction model trained and evaluated in a source 
population to a new target population. In this project, the source population comes
from the Framingham Heart Study (FHS) and the new target population comes from the 
National Health and Nutrition Examination Survey (NHANES) wave 2017. The FHS and NHANES represent two different
populations. The FHS only recruited participants from Framingham, Massachusetts. To be eligible for this FHS at the first examination 
individuals had to be between the ages of 30 and 62 with no previous history of heart disease [3]. In contrast, the NHANES aims
to be a representative sample of the U.S. population of all ages
[2]. 
 
The prediction model for cardiovascular risk used in this project follows the models used in the General Cardiovascular Risk Profile for Use in Primary Care [1]. The model includes log 
transformations for continuous predictor variables of HDLC, total cholesterol, age, and systolic blood pressure measure depending on whether the participant was taking blood pressure medication. The model also includes binary predictor variables as indicators of smoking status and diabetes. 





```{r}
#Load Libraries
library(riskCommunicator)
library(tidyverse)
library(tableone)
library("DescTools")
library(mice)
library(knitr)
library(gclus)
library(naniar)
library(nhanesA)
library(pROC)
library(VIM)
library(mice)
library(yardstick)
library(mvtnorm)
library(rsimsum)
```


# Data Overview

Table 1 below shows the overall characteristics stratified by sex for the 
Framingham study data. In the Framingham data, we observe differences in both outcome
and predictor variables between men and women. Overall, men had a higher proportion for
experiencing a CVD outcome (0.32) compared to women (0.16).
Women tended to have higher total cholesterol and HDLC.Both men and women had similar age distributions. Table 2 below shows the overall characteristics stratified by sex for the NHANES data. Men tended to have higher systolic blood pressure in general. The NHANES data did not include CVD outcome variables. In general, participants in the Framingham study tended to have higher mean levels of total cholesterol and systolic blood pressure. From the distribution plots of continuous variables of the NHANES data, we observe that with the exception of age, BMI, HDLC, total cholesterol, and systolic blood pressure, have a right-skewed distribution. Additionally, missingness in the NHANES dataset comes mainly from the SYSBP_T, SYSBP_UT, and BPMEDS
variables each having greater than 70% missing data. This may be due to the procedure in which the survey questionnaire data was collected, particularly for blood pressure medication usage. 




```{r, out.width='80%', out.height='60%'}
#code provided for framingham data

data("framingham")

# The Framingham data has been used to create models for cardiovascular risk.
# The variable selection and model below are designed to mimic the models used
# in the paper General Cardiovascular Risk Profile for Use in Primary Care 
# This paper is available (cvd_risk_profile.pdf) on Canvas.

framingham_df <- framingham %>% select(c(CVD, TIMECVD, SEX, TOTCHOL, AGE,
                                      SYSBP, DIABP, CURSMOKE, DIABETES, BPMEDS,
                                      HDLC, BMI))
framingham_df <- na.omit(framingham_df)

#CreateTableOne(data=framingham_df, strata = c("SEX"))

# Get blood pressure based on whether or not on BPMEDS
framingham_df$SYSBP_UT <- ifelse(framingham_df$BPMEDS == 0, 
                                 framingham_df$SYSBP, 0)
framingham_df$SYSBP_T <- ifelse(framingham_df$BPMEDS == 1, 
                                framingham_df$SYSBP, 0)

# Looking at risk within 15 years - remove censored data
#dim(framingham_df)
framingham_df <- framingham_df %>%
  filter(!(CVD == 0 & TIMECVD <= 365*15)) %>%
  select(-c(TIMECVD))
#dim(framingham_df)

framingham_df <- framingham_df %>%
  select(-c(DIABP))

# Filter to each sex
framingham_df_men <- framingham_df %>% filter(SEX == 1)
framingham_df_women <- framingham_df %>% filter(SEX == 2)

# Fit models with log transforms for all continuous variables
mod_men <- glm(CVD~log(HDLC+1)+log(TOTCHOL+1)+log(AGE+1)+log(SYSBP_UT+1)+
                   log(SYSBP_T+1)+CURSMOKE+DIABETES, 
               data= framingham_df_men, family= "binomial")


mod_women <- glm(CVD~log(HDLC+1)+log(TOTCHOL+1)+log(AGE+1)+log(SYSBP_UT+1)+
                   log(SYSBP_T+1)+CURSMOKE+DIABETES, 
               data= framingham_df_women, family= "binomial")

framingham_df$SEX <- factor(framingham_df$SEX, levels = c(1, 2), labels = c("Male", "Female"))
CreateTableOne(data = framingham_df, strata = c("SEX"))  %>% kableone(caption = "Framingham Summary Statistics",
                                           bootstrap_options = "striped" ,full_width = F)
framingham_df$SEX <- as.numeric(framingham_df$SEX)
```

```{r, out.width='80%', out.height='60%'}

# blood pressure, demographic, bmi, smoking, and hypertension info
bpx_2017 <- nhanes("BPX_J") %>% 
  select(SEQN, BPXSY1 ) %>% 
  rename(SYSBP = BPXSY1)
demo_2017 <- nhanes("DEMO_J") %>% 
  select(SEQN, RIAGENDR, RIDAGEYR) %>% 
  rename(SEX = RIAGENDR, AGE = RIDAGEYR)
bmx_2017 <- nhanes("BMX_J") %>% 
  select(SEQN, BMXBMI) %>% 
  rename(BMI = BMXBMI)
smq_2017 <- nhanes("SMQ_J") %>%
  mutate(CURSMOKE = case_when(SMQ040 %in% c(1,2) ~ 1,
                              SMQ040 == 3 ~ 0, 
                              SMQ020 == 2 ~ 0)) %>%
  select(SEQN, CURSMOKE)
bpq_2017 <- nhanes("BPQ_J") %>% 
  mutate(BPMEDS = ifelse(BPQ050A == 1, 1, 0)) %>%
  select(SEQN, BPMEDS) 
tchol_2017 <- nhanes("TCHOL_J") %>% 
  select(SEQN, LBXTC) %>% 
  rename(TOTCHOL = LBXTC)
hdl_2017 <- nhanes("HDL_J") %>% 
  select(SEQN, LBDHDD) %>% 
  rename(HDLC = LBDHDD)
diq_2017 <- nhanes("DIQ_J") %>% 
  mutate(DIABETES = case_when(DIQ010 == 1 ~ 1, 
                              DIQ010 %in% c(2,3) ~ 0, 
                              TRUE ~ NA)) %>%
  select(SEQN, DIABETES) 

# Join data from different tables
df_2017 <- bpx_2017 %>%
  full_join(demo_2017, by = "SEQN") %>%
  full_join(bmx_2017, by = "SEQN") %>%
  full_join(hdl_2017, by = "SEQN") %>%
  full_join(smq_2017, by = "SEQN") %>%
  full_join(bpq_2017, by = "SEQN") %>%
  full_join(tchol_2017, by = "SEQN") %>%
  full_join(diq_2017, by = "SEQN")

# Get blood pressure based on whether or not on BPMEDS
df_2017$SYSBP_UT <- ifelse(df_2017$BPMEDS == 0, 
                                 df_2017$SYSBP, 0)
df_2017$SYSBP_T <- ifelse(df_2017$BPMEDS == 1, 
                                df_2017$SYSBP, 0)
#eligibility criteria
df_2017 <- df_2017 %>% filter(AGE >= 30 & AGE <= 62) 

df_2017$SEX <- factor(df_2017$SEX, levels = c(1, 2), labels = c("Male", "Female"))
CreateTableOne(data = df_2017[,-c(1)], strata = c("SEX"))  %>% kableone(caption = "NHANES Summary Statistics",bootstrap_options = "striped" ,full_width = F)


df_2017$SEX <- as.numeric(df_2017$SEX)
```



```{r, out.width='65%', out.height='45%'}
suppressMessages(library(VIM))
# Visualizing missing data
a <- (aggr(df_2017, plot = T, col=c('navajowhite','coral')))

```



```{r, out.width='95%', out.height='90%'}

panel.hist <- function(x, ...) {
    usr <- par("usr")
    on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5))
    his <- hist(x, plot = FALSE)
    breaks <- his$breaks
    nB <- length(breaks)
    y <- his$counts
    y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = rgb(0, 1, 1, alpha = 0.5), ...)
}
          
cpairs(df_2017 %>% select("AGE","BMI","HDLC","TOTCHOL", "SYSBP", "SYSBP_UT",
                          "SYSBP_T"),
      upper.panel = NULL,         
      diag.panel = panel.hist,
      main = "Distribution of NHANES data") 

```









# Model Overview
In fitting the model specified below separately for men and women in the Framingham data, we observe
differences in the estimated odds of experiencing a CVD event, see Table 3 and Table 4 below. The odds of experiencing a CVD event for each increase in the log of age+1 is slightly higher
for women (176.32) compared to men (130.55). Among women taking and not taking blood pressure medication, there
is also an increased odds of experiencing a CVD event for each increase in the log of systolic blood pressure+1 (11.24 and 12.01) compared to men taking and not taking blood pressure medication (7.01 and 7.01). 
Women also have slightly higher odds of experiencing a CVD event if they are a current smoker and have diabetes
compared to men. In general, all the variables included in the model are statistically significant for both men and women.  

The prediction model for cardiovascular risk provided, where the outcome of interest, CVD, is an indicator of experiencing a CVD event, follows the form below:
\begin{figure}[!htb]
  \resizebox{0.85\textwidth}{!}{%
    $\begin{aligned}
      CVD &\sim \log(HDLC+1) + \log(TOTCHOL+1) + \log(AGE+1) \\
      &+ \log(SYSBP\_UT+1) + \log(SYSBP\_T+1) + \text{CURSMOKE} + \text{DIABETES}
    \end{aligned}$
  }
\end{figure}


From fitting the model on the Framingham data, we observe model performance from the ROC plot below. The model
has an AUC of 0.759 indicating the model has good discrimination. With a threshold of 0.201, the model has a sensitivity of 0.792 meaning
the model classifies less false negatives, but a lower specificity of 0.609 indicating the model results in more false positives.

```{r}

summ <- function(mod)
{
  summary_mod <- summary(mod)
# Extract coefficients, p-values, and confidence intervals
coefficients <- coef(summary_mod)[,1]
p_values <- summary_mod$coefficients[, "Pr(>|z|)"]
conf_intervals <- confint(mod)

# Calculate odds ratios
odds_ratios <- exp(coefficients)

# Create a data frame for the results
results_df <- data.frame(
  Coefficient = coefficients,
  Odds_Ratio = odds_ratios,
  PValue = p_values,
  CI_Lower = conf_intervals[, 1],
  CI_Upper = conf_intervals[, 2]
)

# Display the results
return(results_df)
}

tab_men <- summ(mod_men)
tab_women <- summ(mod_women)

tab_men <- tab_men %>% knitr::kable(full_width = F, digits = 3, caption = "Model for Men")
tab_women <- tab_women %>% knitr::kable(full_width = F, digits = 3, caption = "Model for Women")
  
```


```{r}
tab_men
tab_women
```



```{r}
#impute nhanes data
df_2017$BPMEDS <- as.factor(df_2017$BPMEDS)
df_2017$DIABETES <- as.factor(df_2017$DIABETES)
imp <- mice(df_2017, m = 5, maxit = 5, print = FALSE, seed = 123)
#imp$method
```


```{r}
#indicator for source population
framingham_df$ind <- 1

imp_dat <- list()
combined_dat <- list()
combined_dat_men <- list()
combined_dat_women <- list()

for(i in 1:5)
{

imp_dat[[i]] <- complete(imp, i)  
imp_dat[[i]] <- imp_dat[[i]][,c(1:10)] #impute for select variables
imp_dat[[i]] <- cbind(imp_dat[[i]], df_2017[,c("SYSBP_UT","SYSBP_T")])

imp_dat[[i]]$SYSBP_UT <- ifelse(imp_dat[[i]]$BPMEDS == 0, 
                                 imp_dat[[i]]$SYSBP, 0)
imp_dat[[i]]$SYSBP_T <- ifelse(imp_dat[[i]]$BPMEDS == 1, 
                                imp_dat[[i]]$SYSBP, 0)
imp_dat[[i]]$ind <- 0 #indicator of being in nhanes
imp_dat[[i]]$CVD <- NA
imp_dat[[i]] <- imp_dat[[i]][,-1]   #remove seqn

  #Create a combined dataset
  combined_dat[[i]] <- merge(framingham_df, imp_dat[[i]], all = T)
  combined_dat[[i]]$ind <- as.factor(combined_dat[[i]]$ind)
  combined_dat[[i]]$CURSMOKE <- as.numeric(combined_dat[[i]]$CURSMOKE)
  combined_dat[[i]]$DIABETES <- as.numeric(combined_dat[[i]]$DIABETES)
  combined_dat_men[[i]] <- combined_dat[[i]] %>% filter(SEX == 1)
  combined_dat_women[[i]] <- combined_dat[[i]] %>% filter(SEX == 2)  
  
}

```





```{r, out.width='65%', out.height='65%'}
#train-test split
set.seed(1)
sample <- sample(c(TRUE, FALSE), nrow(framingham_df), replace=TRUE, prob=c(0.7,0.3))
train_f <- framingham_df[sample, ]
test_f <- framingham_df[!sample, ]

#train model
mod <- glm(CVD~log(HDLC+1)+log(TOTCHOL+1)+log(AGE+1)+log(SYSBP_UT+1)+
                 log(SYSBP_T+1)+CURSMOKE+DIABETES,
      data= train_f, family= "binomial")

#test the model on framingham data
probs_t <- predict(mod, newdata = test_f, type = "response")
brier_t <- BrierScore(as.numeric(as.character(test_f$CVD)), probs_t)

roc_mod_t <- roc(predictor = probs_t, response = test_f$CVD)
plot(roc_mod_t, print.auc = T,print.thres = "best", main = "Model Performance on Framingham Data" )


```







# Methods
For transportability analysis of the specified prediction model above, we follow the performance measures 
according to Steingrimsson et al[4]. Our source population is the Framingham study population, and our
target population comes from the NHANES study. The outcome of interest is only observed in the Framingham study.
This is referred to as a "non-nested" sampling design, where samples are obtained separately from the source and
target populations. Using these samples a composite dataset is generated, and split randomly into a test and train data. The model is built on the training data to obtain, $E[Y|X, S = 1]$, where Y is the CVD outcome, conditional
on the predictor variables given that the data is in the source population indicated
by S = 1. Additionally, inverse-odds weights are estimated separately for both the training and testing data to ensure
independence when estimating model performance. 

Model performance can be evaluated through the target population MSE given by:

$$\hat{\psi}_{\hat{\beta}} = \frac{\sum_{i=1}^{n}I(S_i = 1,D_{\text{test},i} = 1)\hat{o}(X_{i})(Y_{i} - g_{\hat{\beta}}(X_{i}))^2}{\sum_{i=1}^{n}I(S_{i}=0, D_{\text{test},i} = 1)}[4]$$


In the formula, $\hat{o}(X)$ is an estimator the inverse-odds weights in the test set,
$\frac{{\Pr[S = 0|X, D_{test,i} = 1]}}{\Pr[S = 1|X, D_{test,i} = 1]}$. 

The difference between the actual observed outcome and model-derived predicitions are denoted by
$Y_{i} - g_{\hat{\beta}}(X_{i})$.


Two assumptions made, (1) independence of the CVD outcome and the population S conditional on the
covariates and (2) a positivity assumption for target data given the covariates based on covariate patterns
from the source data.

In order to use this data for a transportability analysis, the NHANES data was limited to include participants ages 30 to 62 to match the eligibility criteria of the Framingham data. Also, due to the amount of missing data, multiple
imputation was performed. Estimates were calculated and averaged across all five imputed datasets to obtain the true target population brier score.


# Simulation Design
In addition to estimating model performance in the observed source Framingham data and its
transportability to the new target NHANES data, we also estimate model performance in simulated
target data. In this case, with having an already established model, all simulated data is used
to evaluate model performance and no train-test split is performed. We consider a simulation study following an ADEMP framework as follows:

The **AIM**, of this study is to evaluate the performance of a prediction model developed from the Framingham Heart 
Study source data in a new target population underlying the NHANES data. As for the **Data-Generating Mechanism**, a target population was simulated by first generating
the continuous variables using the mvrnorm function from the
mvtnorm package in R. These variables include total cholesterol, age, systolic blood
pressure, HDLC, and BMI.The parameters used to generate these variables are the mean values from the summary statististics of the NHANES dataset, and
a specified covariance matrix following the covariance pattern of these variables from the Framingham data. 
Categorical variables were generated sampling from a Bernoulli distribution to achieve the proportions from the summary statistics of the NHANES data. These categorical binary variables include diabetes, blood pressure medication, and smoking status. Using this simulated data, variables for systolic bloop pressure based on blood pressure medication usage were added. Data was generated seperately for men and women using the stratified mean summary statistics and Framingham data
sets for each strata to get a combined dataset of n = 2,000 with equal proportions of men and women. 


The evaluated model predicts the proportion of individuals who were predicted to have CVD given the X covariates 
in the combined dataset using the model developed from the FHS. Our **estimand** of interest is the target
population MSE. **Performance measures** for the simulated data are assessed through the resulting bias from the "true" MSE estimate calculated from the non-simulated data, in addition to MC empirical standard errors and confidence intervals.



```{r}

brier_risk <- function(dat)
{
set.seed(123)
#i = 1
sample <- sample(c(TRUE, FALSE), nrow(dat), replace=TRUE, prob=c(0.7,0.3))
train_c <- dat[sample, ]
test_c <- dat[!sample, ]

inv_w <- glm(ind ~ log(HDLC+1) + log(TOTCHOL+1) + log(AGE +1)+log(SYSBP_UT+1)+ log(SYSBP_T+1)+
               CURSMOKE+DIABETES,
                 family = binomial(), data = train_c)

probs <- predict(inv_w, newdata=test_c, type = "response")
inv_odds_w <- (1-probs)/probs

#brier risk
mod_com <- glm(CVD~log(HDLC+1)+log(TOTCHOL+1)+log(AGE+1)+log(SYSBP_UT+1)+
                 log(SYSBP_T+1)+ CURSMOKE+ DIABETES, 
      data= train_c, family= "binomial")

y_pred <- predict(mod_com, newdata=test_c, type = "response")
sq_err <- (as.numeric(test_c$CVD) - y_pred)^2
est <- inv_odds_w[test_c$ind == 1] * sq_err[test_c$ind == 1]
est <- sum(est)/sum(test_c$ind == 0)

return(est)
}

estimates_men <- list()
estimates_women <- list()
combined_estimates <- list()
for(i in 1:5)
{
  estimates_men[[i]] <- brier_risk(combined_dat_men[[i]])
  estimates_women[[i]] <- brier_risk(combined_dat_women[[i]])
  combined_estimates[[i]] <- brier_risk(combined_dat[[i]])
}
```



```{r}
brier_cal <- function(dat)
{
# w/ no sampling
inv_w <- glm(ind ~ log(HDLC+1) + log(TOTCHOL+1) + log(AGE +1)+log(SYSBP_UT+1)+ log(SYSBP_T+1)+ CURSMOKE+DIABETES,
                 family = binomial(), data = dat)
probs <- predict(inv_w, type = "response")
inv_odds_w <- (1-probs)/probs

#brier risk
mod_com <- glm(CVD~log(HDLC+1)+log(TOTCHOL+1)+log(AGE+1)+log(SYSBP_UT+1)+
                 log(SYSBP_T+1)+ CURSMOKE+ DIABETES, 
      data= dat, family= "binomial")

y_pred <- predict(mod_com, type = "response")
sq_err <- (as.numeric(dat$CVD) - y_pred)^2
est <- inv_odds_w[dat$ind == 1] * sq_err[dat$ind == 1]
est <- sum(est)/sum(dat$ind == 0)
return(est)
}

```











```{r}
###########################
#generate simulated data
##########################

generate_continuous <- function(dat, mean)
{
  #get the covariance matrix and means for continuous variables from the source population
  predictor_df <- dat %>% dplyr::select(c(SYSBP,AGE,BMI,HDLC,TOTCHOL))
  cov_mat <- cov(predictor_df)
  pred_mean <- mean
                              
  n <- 1000
  X <- rmvnorm(n, mean = as.numeric(pred_mean), sigma = as.matrix(cov_mat))
  X[,c(2)] <- pmax(30, X[,c(2)])
  X[,c(1,3:5)] <- pmax(0, X[,c(1,3:5)])
  X <- matrix(X, ncol = 5)
  X <- as.data.frame(X)
  return(X)
}


generate_Data <- function(dat, vals, prop)
{
#from baseline characteristics for men 
sim <- generate_continuous(dat, vals)
colnames(sim) <- c("SYSBP","AGE","BMI","HDLC","TOTCHOL")
sim <- as.data.frame(sim)
CURSMOKE <- rbinom(1000, size = 1, prop["CURSMOKE"])
sim <- cbind(sim, CURSMOKE = CURSMOKE)
BPMEDS <- rbinom(1000, size = 1, prop["BPMEDS"])
sim <- cbind(sim, BPMEDS = BPMEDS)
DIABETES <- rbinom(1000, size = 1, prop["BPMEDS"])
sim <- cbind(sim, DIABETES = DIABETES)
return(as.data.frame(sim))
}

```


```{r}
#values for men
vals_m <- data.frame(SYSBP = c(126.07), AGE = c(47.16), BMI = c(30.19), 
                              HDLC = c(47.45), TOTCHOL = c(192.86))
prop_val_m <- c(CURSMOKE = 0.26, DIABETES = 0.13, BPMEDS = 0.76)

#values for women
vals_w <- data.frame(SYSBP = c(122.46), AGE = c(46.75), BMI = c(30.77), 
                              HDLC = c(57.59), TOTCHOL = c(195.40))
prop_val_w <- c(CURSMOKE = 0.17, DIABETES = 0.11, BPMEDS = 0.80)

mc_sim <- function()
{
  output_m <- generate_Data(framingham_df_men, vals_m, prop_val_m)
  output_m$SEX <- 1
  output_w <- generate_Data(framingham_df_women, vals_w, prop_val_w)
  output_w$SEX <- 2
  
  output <- rbind(output_m, output_w)
  output$ind <- 0
  
  output$SYSBP_UT <- ifelse(output$BPMEDS == 0, 
                                 output$SYSBP, 0)
  output$SYSBP_T <- ifelse(output$BPMEDS == 1, 
                                output$SYSBP, 0)
  output$CVD <- NA
  framingham_df$ind <- 1
  sim_dat <- merge(framingham_df, output, all = T)

  est <- numeric(length = 3)
  est[1] <- brier_cal(dat = sim_dat %>% filter(SEX == 1))
  est[2] <- brier_cal(dat = sim_dat %>% filter(SEX == 2))
  est[3] <- brier_cal(dat = sim_dat)
 return((est))

}

```




```{r}
#Example of generated data -using code from function

  output_m <- generate_Data(framingham_df_men, vals_m, prop_val_m)
  output_m$SEX <- 1
  output_w <- generate_Data(framingham_df_women, vals_w, prop_val_w)
  output_w$SEX <- 2
  
  output <- rbind(output_m, output_w)
  output$ind <- 0
  
  output$SYSBP_UT <- ifelse(output$BPMEDS == 0, 
                                 output$SYSBP, 0)
  output$SYSBP_T <- ifelse(output$BPMEDS == 1, 
                                output$SYSBP, 0)
  output$CVD <- NA
 
```


```{r, out.width='95%', out.height='90%'}

cpairs(output %>% select("AGE","BMI","HDLC","TOTCHOL", "SYSBP","SYSBP_UT", "SYSBP_T"),
      upper.panel = NULL,         
      diag.panel = panel.hist,
      main = "Example Distribution of Simulated Data") 
```



## Simulated Data Overview
The plot above shows the distribution of the simulated data. This data follows the mean values of the actual NHANES data, but as observed in the plot, is normally distributed in comparison to the actual NHANES data which has a
skewed distribution for a majority of variables with the exception of age which is uniformly distributed. The binary variables, diabetes,
blood pressure medication, and smoking status (not shown in the plot) match the proportions of the NHANES summary statistics.



# Results and Discussion

The brier estimates were calculated using the actual combined data from the framingham and NHANES.
Table 5 below shows the results. The brier estimate for the overall combined data was 0.0404. In stratifiying by
sex, men had a higher brier estimate of 0.0469 and women had a lower estimate of
0.0331. This indicates the model predictions performed slightly better for women. These values will be referred to as the "true" target brier estimates for comparison purposes
in the simulation study.

Tables 5 to 7 show the results for men, women, and combined simulated data with n = 1,000 repetitions. The simulation mean estimate was 0.2775 for men and 0.0649 for women. In reference to the "true" brier estimate, the bias for men,0.2306, was comparatively larger than the bias for women, 0.0318, across simulations. The overall mean estimate across simulations for both men and women is 0.1271. In addition, the histogram of the estimates shows there is not a large variability in the range of brier scores for the 1,000 simulations. There is a larger deviation from the true value in the histogram for the right-tail values, but for the most part the estimates have a right-skewed distribution. We observe that similar to the non-simulated estimates, the model performs better in women compared to men. 

In applying this model to the underlying target population in the simulated NHANES data, our results might have been affected by how well the model in general performs in women compared to men. When fitting the model to the Framingham data separately for men and women, the model summary showed an AIC of 1249.8 with a residual deviance of 1233.8 for men compared to lower values for women having an AIC of 1106.1 with a residual deviance of 1090.1.To add, in assuming only summary level statistics are available from the new target population, our data-generating mechanism was limited to a random sampling from a normal distribution
with the variable means matching the summary statistics provided. This simulated NHANES data is different than the source population data in which the model was developed. Despite this, the model performed relatively well in the combined simulated data men and women, with the model performing the best for women and worse for men. 



```{r}
df <- data.frame(Data = c("Men", "Women", "Combined"))
df2 <- rbind(mean(as.numeric(estimates_men)), mean(as.numeric(estimates_women)),
            mean(as.numeric(combined_estimates)))
df <- cbind(df, Estimate = c(df2))

df %>% knitr::kable(full_width = F, digits = 4, caption = "True Target Brier Estimates")
```


```{r}
output <- numeric(length=1000)
set.seed(123)
output <- replicate(1000, mc_sim())
output_df <- t(output)
output_df <- as.data.frame(output_df)

par(mfrow=c(2,2))
hist(output_df$V1, main = "Simulation Estimates for Men", xlab = "Brier Score")
hist(output_df$V2, main = "Simulation Estimates for Women", xlab = "Brier Score")
hist(output_df$V3, main = "Overall Simulation Estimates", xlab = "Brier Score")
  

```



```{r}
ss1 <- data.frame(dataset = 1:1000, ALL = output_df[,1])
ss2 <- data.frame(dataset = 1:1000, ALL = output_df[,2])
ss3 <- data.frame(dataset = 1:1000, ALL = output_df[,3])
simsum_1 <- simsum(data = ss1, estvarname = "ALL", true = 0.0469, x = F)
simsum_2 <- simsum(data = ss2, estvarname = "ALL", true = 0.0331, x = F)
simsum_3 <- simsum(data = ss3, estvarname = "ALL", true = 0.0404, x = F)

s1 <- summary(simsum_1)
#s1 <- tidy(s1)[c(2,4:6),]
s2 <- summary(simsum_2)
#s2 <- tidy(s2)[c(2,4:6),]
s3 <- summary(simsum_3)
#s3 <- tidy(s3)[c(2,4:6),]

knitr::kable(tidy(s1), caption = "Men: True Value = 0.0469", stats = c("thetamean", "bias", "empse", "mse"), digits = 5,
col.names = c("Measure", "Estimate", "MCSE", "Lower", "Upper")) 

knitr::kable(tidy(s2), caption = "Women: True Value = 0.0331", stats = c("thetamean", "bias", "empse", "mse"), digits = 5,
col.names = c("Measure", "Estimate", "MCSE","Lower", "Upper"))

knitr::kable(tidy(s3), caption = "Overall: True Value = 0.0404", stats = c("thetamean", "bias", "empse", "mse"), digits = 5,
col.names = c("Measure", "Estimate", "MCSE","Lower", "Upper")) 

```





# Conclusion
In this study, the performance of a predictive model was evaluated through a MC simulation using data generated separately for men and women to create a target population. The simulation involved 1,000 repetitions, and for each repetition the brier score as defined previously using an inverse-odds weighting estimator was calculated. Our results showed the mean estimate for men was 0.2775, considerably higher than the estimate for women at 0.0649. The bias in the simulation mean estimate was more pronounced for men (0.2306) compared to women (0.0318) in reference to the "true" estimated from the non-simulated data. The overall mean brier estimate across simulations for the combined data of men and women was 0.1271.

When applying the model to the simulated NHANES data, potential differences between men and women were observed. This may be due to what was previously observed when fitting the model separately for men and women on Framingham data yielded higher AIC and residual deviance values for men. This discrepancy suggested that the model might be less effective when applied to the underlying target population particularly for men. Moreover, a limitation is due to our data-generating mechanism. Simulated NHANES data was generated by random sampling from a normal distribution which differed from the source population data used to develop the model. However, the model still performed relatively well in the combined simulated data for men and women, with better performance in women than men. In conclusion, this project highlights the performance of the predictive model developed on a source population when applied to simulated data when only overall population statistics without data for the outcome of interest in the target population are available.



# References

Centers for Disease Control and Prevention. (2023, May 31). About NHANES. National Center for Health Statistics. https://www.cdc.gov/nchs/nhanes/about_nhanes.htm

D'Agostino, R. B. Sr, Vasan, R. S., Pencina, M. J., Wolf, P. A., Cobain, M., Massaro, J. M., & Kannel, W. B. (2008). General Cardiovascular Risk Profile for Use in Primary Care. The Framingham Heart Study. Circulation, 117, 743–753. https://doi.org/10.1161/CIRCULATIONAHA.107.699579

National Heart, Lung, and Blood Institute. (n.d.). Framingham Heart Study. National Institutes of Health. https://www.nhlbi.nih.gov/science/framingham-heart-study-fhs

Steingrimsson, J. A., Gatsonis, C., Li, B., & Dahabreh, I. J. (2023). Transporting a Prediction Model for Use in a New Target Population. American Journal of Epidemiology, 192(2), 296–304. https://doi.org/10.1093/aje/kwac128

# Appendix: All code for this report

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}

```

